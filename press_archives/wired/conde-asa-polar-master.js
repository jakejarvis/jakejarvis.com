/* Script:Conde%20Shared%20Tag - ScriptInstance:c2345c4dc94948a782458a77c3da7729 - CompiledAt:2018-11-15 16:53:09 */

(function(){window.PolarConde=window.PolarConde||[];var exec=function(item){log("Message received with contents:",item);var name;if(typeof item!=="object"||item.length<1||typeof(name=item[0])!=="string"){return}switch(name){case"onRender":onRender(item[1]);break;case"onFill":onFill(item[1],item[2]);break;case"onError":onError(item[1],item[2],item[3]);break;default:break}};var log=function(){if(window.location.search.indexOf("mvdebug=1")>-1){var args=1<=arguments.length?[].slice.call(arguments,0):[];args.unshift("[PolarConde]");console.log.apply(console,args)}};var init=function(){window.NATIVEADS=window.NATIVEADS||{};window.NATIVEADS_QUEUE=window.NATIVEADS_QUEUE||[];injectScript("nativeads-plugin","//plugin.mediavoice.com/plugin.js")};var boot=function(){var existingQueue=window.PolarConde;window.PolarConde={push:function(){var items=1<=arguments.length?[].slice.call(arguments,0):[];for(var i=0;i<items.length;i++){exec(items[i])}}};if(typeof existingQueue==="object"){for(var i=0;i<existingQueue.length;i++){exec(existingQueue[i])}existingQueue=null}};var getPropertyID=function(hostname,organization,callback){var request=new XMLHttpRequest;request.open("GET","//meraxes-cdn.polarmobile.com/nativeads/v1.4.0/json/hostname/"+hostname+"/organization/"+organization,true);request.onload=function(){if(request.status>=200&&request.status<400){var data=JSON.parse(request.responseText);log("[Property ID Lookup] Response:",data);callback(null,data.property)}else{log("[Property ID Lookup] Server responded with error:",request.status,request.statusText);callback(true)}};request.onerror=function(){log("[Property ID Lookup] Connection error.");callback(true)};request.send()};var onRender=function(context){var $=context.$;var destinationURLs=$.map(context.fill.creatives,function(creative,index){return creative.link});context.$template.find("a").each(function(){var url=$(this).attr("href");if($.inArray(url,destinationURLs)!==-1&&url.indexOf("#polar-deck-link")<0){var urlObj={intcid:"polar",utm_source:"polar",utm_medium:"nativetile"};var updatedURL=updateQueryStringParameter(url,urlObj);$(this).attr("href",updatedURL);log("[Render] Updated destination URL:",{from:url,to:updatedURL})}})};var onFill=function(context,creative,jQuery){};var onError=function(context,srcWindow,config){log("[Error] Failed with:",context.err);if(context.err!=="NO_CREATIVES_IN_PROMOFEED"){return}var div=context.$(srcWindow.frameElement).closest(".cns-ads-stage");var hide=function(){div.removeClass("cns-ads-slot-state-filled").addClass("cns-ads-slot-state-empty").hide()};hide();setTimeout(hide,10);setTimeout(hide,1e3);log("[Empty Promo Feed] Updated ad delivery div:",div);if(config!=null&&config.backfill!=null){log("[Empty Promo Feed] Preparing to backfill for:",{context:context,srcWindow:srcWindow,config:config});try{var tag=JSON.parse(context.$("script[type='text/mediavoice-tag']",srcWindow.document).text());if(tag.source==null||tag.source.id==null){log("[Empty Promo Feed] Unable to backfill because `tag.source` or `tag.source.id` are null. Tag:",tag);return}if(tag.source.id==config.backfill){log("[Empty Promo Feed] Aborting backfill because being asked to backfill to the same Promo Feed.",{tag:tag,config:config});return}tag.source.id=config.backfill;var injectionLocation=context.$(srcWindow.frameElement);var iframe=context.$('<iframe class="mediavoice-pf-backfill" frameborder="0" width="1" height="1" marginheight="0" marginwidth="0" style="border: 0px;" />').insertBefore(injectionLocation);var iframeDocument=iframe[0].contentDocument;iframeDocument.open();iframeDocument.write('<script type="text/mediavoice-tag" data-mediavoice-tag-version="2">');iframeDocument.write(JSON.stringify(tag,null,2));iframeDocument.write("</script>");iframeDocument.write('<script type="text/javascript" src="//static.polarcdn.com/creative/creative.js"></script>');iframeDocument.close()}catch(e){log("[Empty Promo Feed] Exception thrown during backfill tag injection for:",{context:context,srcWindow:srcWindow,config:config,e:e})}log("[Empty Promo Feed] Backfill tag injected successfully for:",{context:context,srcWindow:srcWindow,config:config})}};var updateQueryStringParameter=function(url,obj){for(key in obj){var re=new RegExp("([?&])"+key+"=.*?(&|$)","i");var separator=url.indexOf("?")!==-1?"&":"?";if(url.match(re)){url=url.replace(re,"$1"+key+"="+obj[key]+"$2")}else{url=url+separator+key+"="+obj[key]}}return url};var injectScript=function(id,url){(function(d,s,i,u){var js,fjs=d.getElementsByTagName(s)[0],p=d.location.protocol;if(d.getElementById(i)){return}js=d.createElement(s);js.id=i;js.type="text/javascript";js.async=true;js.src=(p=="https:"?p:"http:")+u;fjs.parentNode.insertBefore(js,fjs)})(document,"script",id,url)};log("Loading MV Script.");init();boot();log("Loaded MV Script.");log("Looking up MV Property ID.");getPropertyID(window.location.hostname,"condenastcorporate",function(error,property){if(error!=null){log("Unable to determine Property ID.");log("Will not enable secondary page tracking, because Property ID unknown.");return}log("MV Property ID is:",property);window.NATIVEADS_QUEUE.push(["setPropertyID",property]);if(property==="NA-WIRE-11238836"){log("Injecting Wired-specific script.");injectScript("nativeads-wired-hosted","//cdn.mediavoice.com/nativeads/script/condenastcorporate/wired-hosted-content.js");return}window.NATIVEADS_QUEUE.push(["configureSecondaryPage",{track:function(){log("Configuring secondary page tracking.");if(window.location.pathname.indexOf("/branded")==0||window.location.pathname.indexOf("/brandlab")==0||window.location.pathname.indexOf("sponsor-content")>-1||window.location.search.indexOf("mvt=i")>-1||window.location.search.indexOf("mvt=o")>-1||window.location.search.indexOf("plrsrc=")>-1){log("This is a branded content page (because `/branded` or `/brandlab` or contains `sponsor-content` or `?intcid=polar` or `?plrsrc=`); tracking pageview.");return"inbound"}else{log("This is not a branded content page; not tracking pageview.");return false}}}])})})();
